<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[Module] asyncio</title>

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:300' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/style.css">
  <link rel="canonical" href="http://localhost:4000/python/0201/01/01/asyncio.html">
  <link rel="alternate" type="application/rss+xml" title="Your awesome title" href="http://localhost:4000/feed.xml">

  	<!-- 폰트 및 코드 하이라이팅 -->
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/androidstudio.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<link href="https://fonts.googleapis.com/css?family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>


  <body>

    <div class='wrapper'>

    <!--<input data-function='swipe' id='swipe' type='checkbox'>-->
    <!--<label data-function='swipe' for='swipe' class="btn btn-default" >Menu</label>-->


    <!--<div class='sidebar menu'>-->
    <div id="test">


        <div class="menu">

            <div class="navigation">
                <ul>
                    

                    
                    
                    
                    
                    <li><a href="/">Home</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>


            <hr>

            <div class="navigation">
                <ul>
                    
                    <li>
                        <a href="/categories/Python">Python</a></li>
                    
                    <li>
                        <a href="/categories/Etc">Etc</a></li>
                    
                    <li>
                        <a href="/categories/CodingTest">CodingTest</a></li>
                    
                    <li>
                        <a href="/categories/AWS">AWS</a></li>
                    
                    <li>
                        <a href="/categories/Django">Django</a></li>
                    
                    <li>
                        <a href="/categories/DataStructure">DataStructure</a></li>
                    
                </ul>
            </div>

            <hr>

            <!--<div id="picture" style="background-image: url(http://www.naturaloil.ph/wp-content/uploads/2015/11/John_Doe.jpg)"></div>-->
            <p>One sentence introducing yourself or what you do</p>

            <hr>


            <div id="social-icons">
                <ul>
                    <!--<li><a href="http://facebook.com/username"><i class="fa fa-facebook"></i></a></li>-->
                    <!--<li><a href="https://mx.linkedin.com/in/username"><i class="fa fa-linkedin"></i></a></li>-->
                    <li><a href="http://github.com/username"><i class="fa fa-github"></i></a></li>
                    <!--<li><a href="http://username.deviantart.com"><i class="fa fa-deviantart"></i></a></li>-->
                    <!--<li><a href="http://codepen.io/username"><i class="fa fa-codepen"></i></a></li>-->
                </ul>
            </div>

            <hr>

            <!--<p>© Taken theme<p>-->
            <!--<p>Powered by Jekyll<p>-->

        </div>
    </div>

    <div class='content'>
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
     <h2 class="post-title">[Module] asyncio</h2>
     <p class="post-meta"><time datetime="0201-01-01T00:01:44+08:27" itemprop="datePublished">Jan 1, 0201</time></p>
      <hr>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h3 id="asyncio-정리">asyncio 정리</h3>

<h4 id="couroutine-이란">couroutine 이란?</h4>

<p>코루틴의 개념을 이해하기 위해서 서브루틴의 개념을 먼저 이해하자.</p>

<ul>
  <li>
    <p>서브루틴이란?<br />
서브루틴은 함수, 메서드에 해당되며 메인 루틴에서 서브루틴을 실행 할 경우 특정 지점(서브)에서 return 이 될때까지 루틴을 실행한 후 원위치(메인)로 돌아온다.</p>
  </li>
  <li>
    <p>코루틴과 서브루틴의 차이점 2가지</p>

    <ul>
      <li>코루틴의 경우, return 이 아닌 yield 를 통해 값을 전달하며 값을 내놓았다는 것이 해당 루틴의 종료를 의미하는 것이 아니라 중단되었음을 의미한다. 이는 멈춘 지점으로 돌아와 다시 코루틴을 실행할 수 있음을 의미한다.<br />
한마디로 중간에 멈춰서 특정위치로 돌아갔다가 다시 원래위치로 돌아와 나머지 루틴을 실행할 수 있다.</li>
      <li>서브루틴의 진입점과 반환점은 한 개뿐이지만 코루틴은 여러개의 진입지저이 존재한다.</li>
    </ul>
  </li>
</ul>

<p>코루틴을 이해하기 위해서 yield 를 살펴보자.</p>

<ul>
  <li>
    <p>yield 란?<br />
python generator 객체에 사용되는 문법이며 generator 객체 생성 후 next() 함수를 실행하면 다음 yield 지점에서 값을 내놓도록 동작한다.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">print_abc</span><span class="p">():</span>
      <span class="k">yield</span> <span class="k">print</span><span class="p">(</span><span class="s">'a'</span><span class="p">)</span>
      <span class="k">yield</span> <span class="k">print</span><span class="p">(</span><span class="s">'b'</span><span class="p">)</span>
      <span class="k">yield</span> <span class="mi">1</span>
    
  <span class="n">a</span> <span class="o">=</span> <span class="n">print_abc</span><span class="p">()</span>
  <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
    
  <span class="c1"># a
</span>  <span class="c1"># b
</span>  <span class="c1"># c
</span></code></pre></div>    </div>

    <p><code class="highlighter-rouge">yield x</code> 에서 yield 는 값을 내놓은 ‘시점/지점’ 에 해당하며 x 는 내놓을 ‘값’에 해당한다.</p>

    <ul>
      <li>
        <p>send() 를 통해 값을 전달할 수도 있다.</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="s">'start test1 coroutine'</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">i</span><span class="p">:</span>
          <span class="n">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">i</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">b</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">test1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        
  <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
        
  <span class="c1"># start test1 coroutine
</span>  <span class="c1"># 5
</span>  <span class="c1"># 8
</span>  <span class="c1"># 15
</span></code></pre></div>        </div>

        <p><code class="highlighter-rouge">b = yield i</code> 에서 b 는 send() 를 통해 ‘전달되는 값의 변수명’ 에 해당한다. ‘=’ 때문에 b 의 의미가 약간 헷갈리긴 하지만 일단 코드상에서 하는 역할은 저렇다.</p>
      </li>
      <li>
        <p>genarator 객체이기때문에 for 문에 다음과 같이 활용가능하다.</p>

        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">n</span>
          <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">countdown</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">" "</span><span class="p">)</span>
        
  <span class="c1">### 5 4 3 2 1
</span></code></pre></div>        </div>
      </li>
      <li>
        <p>만약 100까지의 숫자를 리스트에 담도록한다면 range 를 사용할 경우 100개의 숫자를 가져올 메모리 공간이 필요하다. 하지만 yield 를 사용하면 숫자를 100번에 나눠 가져올 수 있으므로 메모리 공간을 절약할 수 있다. 이 점이 yield 제네레이터의 유용성이라고 한다.</p>
      </li>
    </ul>
  </li>
</ul>

<p>코루틴은 보통 caller 와 callee 로 존재하는 종속적인 관계의 흐름에 해당되지 않는다. 코루틴을 동작하게 하기 위해선 호출이 필요하지만 이를 종속적으로 보지 않고 대등하게 값을 입력하고 내어주는 대등한 관계의 흐름이라고 본다. 제어권을 주고 받는다고 이해하자.<br />
이때 값의 입력과 값을 가져온다는 의미가 중요하다. 값의 입력은 send() 를 통해 이뤄지는데 <code class="highlighter-rouge">b = yield i</code> 의 경우 b 를 입력하고 i 를 가져오게된다.<br />
이해하기가 좀 어렵지만 언제든지 코루틴에 해당되는 동작을 이어서 실행할 수 있고 대기 상태로 값의 입력을 받을 수 있기때문에 서브루틴과 다른 방식이라고 받아들이면 될 것 같다.</p>

<h4 id="비동기-io-코루틴을-위한-asyncio">비동기 IO 코루틴을 위한 asyncio</h4>

<ul>
  <li>
    <p>코루틴</p>

    <blockquote>
      <p>A coroutine is a special function that can give up control to its caller without losing its state. A coroutine is a consumer and an extension of a generator. One of their big benefits over threads is that they don’t use very much memory to execute. Note that when you call a coroutine function, it doesn’t actually execute. Instead it will return a coroutine object that you can pass to the event loop to have it executed either immediately or later on.</p>
    </blockquote>
  </li>
  <li>
    <p>future</p>

    <blockquote>
      <p>One other term you will likely run across when you are using the asyncio module is future. A future is basically an object that represents the result of work that hasn’t completed. Your event loop can watch future objects and wait for them to finish. When a future finishes, it is set to done. Asyncio also supports locks and semaphores.</p>
    </blockquote>
  </li>
  <li>
    <p>Task</p>

    <blockquote>
      <p>The last piece of information I want to mention is the Task. A Task is a wrapper for a coroutine and a subclass of Future. You can even schedule a Task using the event loop.</p>
    </blockquote>
  </li>
</ul>

<p>안타깝게도 asyncio 에서 사용되는 코루틴은 genarator 기반의 코루틴과 다른 방식이라고 한다. 하지만 동작하는 개념은 동일한 듯하고 단지 사용하는 문법적인 측면에서 다른점이 있는 듯하다.<br />
asyncio 에서는 async 와 await 문법을 사용하여 비동기 IO 를 구현한다. 밑의 설명을 보니 genarator 와 비교해서 async, await 를 언급한다.</p>

<blockquote>
  <p>The async and await keywords were added in Python 3.5 to define a native coroutine and make them a distinct type when compared with a generator based coroutine. If you’d like an in-depth description of async and await, you will want to check out PEP 492.</p>
</blockquote>

<ul>
  <li>
    <p>async 란?<br />
코루틴으로 정의하려는 함수의 def 앞에 붙여준다.</p>
  </li>
  <li>
    <p>await 란?<br />
코루틴 함수 내부에서 비동기 작업을 호출할 때 앞에 붙여줘야하며 호출되는 함수 역시 비동기 코루틴(async 가 붙은)함수여야 한다. 병렬적으로 코드가 실행될 지점에 붙여주면 되며 await 가 붙은 지점에서 요청을 보낸 후 기다리는 시간 동안 다음 task 를 진행하는 시점이 된다.</p>
  </li>
  <li>
    <p>ensure_future() 란?<br />
async 나 await 로 작성된 코루틴은 create_task(coroutine) 을 통해 TASK 객체가 된다. task 객체가 아니라면 loop 를 실행시킬 수 없으므로 필수적으로 create_task()를 해주어야 한다.<br />
이때 ensure_future(coroutine) 과 같이 코루틴 함수를 인자로 넣어 실행시켜주면 ensure_future() 안쪽에서 create_task() 를 실행시켜서 TASK 객체를 만들어준다.<br />
그외에도 Future 객체인지 검사한 후 아닐 경우 ValueError 를 발생시키는 역할 또한 존재한다.</p>
  </li>
</ul>

<h4 id="브런치-프로젝트에-사용한-코드request-및-aiohttp">브런치 프로젝트에 사용한 코드(request 및 aiohttp)</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">detail_crawl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">article_txid</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'Send request .. {url}'</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>
    <p>aiohttp.ClientSession() 란?<br />
client 에 해당되는 나의 세션 객체를 생성하며 안쪽에서 loop 를 get 하게된다. get 한 loop 를 통해 request 작업을 실행한다.</p>
  </li>
  <li>
    <p>코드 작동<br />
위에서 설명 했듯이 await 코드 바로 위쪽에서 다음 TASK 로 넘어가게 된다. 다음 TASK 로 넘어갈 경우 다시 loop 를 get 하게 되며 첫번째 loop 와 두번째 loop 는 동일하다. 또한 디버그를 통해 thread_id 값이 같음을 확인했으므로 멀티쓰레드와 비동기가 다른 방식이라는 것을 확인할 수 있다.</p>
  </li>
</ul>

  </div>

  <!-- To enable Disqus comments, comment out this code and insert your Disqus shortname -->

  <!--  -->

</article>

    </div>
</div>

      
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-2.x-git.min.js"></script>
      
    <!-- Bootstrap Core JavaScript -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <script src="/js/index.js"></script>

  </body>

    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>

    <script>
    $(document).ready(function(){
    $('#page-content-wrapper').fadeIn();
    });
    </script>

</html>
