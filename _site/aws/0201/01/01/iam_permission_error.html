<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>EB create 실행 시 IAM permission Error 해결하기</title>

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:300' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/style.css">
  <link rel="canonical" href="http://localhost:4000/aws/0201/01/01/iam_permission_error.html">
  <link rel="alternate" type="application/rss+xml" title="Your awesome title" href="http://localhost:4000/feed.xml">

  	<!-- 폰트 및 코드 하이라이팅 -->
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/androidstudio.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<link href="https://fonts.googleapis.com/css?family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>


  <body>

    <div class='wrapper'>

    <!--<input data-function='swipe' id='swipe' type='checkbox'>-->
    <!--<label data-function='swipe' for='swipe' class="btn btn-default" >Menu</label>-->


    <!--<div class='sidebar menu'>-->
    <div id="test">


        <div class="menu">

            <div class="navigation">
                <ul>
                    

                    
                    
                    
                    
                    <li><a href="/">Home</a></li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>


            <hr>

            <div class="navigation">
                <ul>
                    
                    <li>
                        <a href="/categories/Python">Python</a></li>
                    
                    <li>
                        <a href="/categories/Etc">Etc</a></li>
                    
                    <li>
                        <a href="/categories/CodingTest">CodingTest</a></li>
                    
                    <li>
                        <a href="/categories/AWS">AWS</a></li>
                    
                    <li>
                        <a href="/categories/Django">Django</a></li>
                    
                    <li>
                        <a href="/categories/DataStructure">DataStructure</a></li>
                    
                </ul>
            </div>

            <hr>

            <!--<div id="picture" style="background-image: url(http://www.naturaloil.ph/wp-content/uploads/2015/11/John_Doe.jpg)"></div>-->
            <p>One sentence introducing yourself or what you do</p>

            <hr>


            <div id="social-icons">
                <ul>
                    <!--<li><a href="http://facebook.com/username"><i class="fa fa-facebook"></i></a></li>-->
                    <!--<li><a href="https://mx.linkedin.com/in/username"><i class="fa fa-linkedin"></i></a></li>-->
                    <li><a href="http://github.com/username"><i class="fa fa-github"></i></a></li>
                    <!--<li><a href="http://username.deviantart.com"><i class="fa fa-deviantart"></i></a></li>-->
                    <!--<li><a href="http://codepen.io/username"><i class="fa fa-codepen"></i></a></li>-->
                </ul>
            </div>

            <hr>

            <!--<p>© Taken theme<p>-->
            <!--<p>Powered by Jekyll<p>-->

        </div>
    </div>

    <div class='content'>
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
     <h2 class="post-title">EB create 실행 시 IAM permission Error 해결하기</h2>
     <p class="post-meta"><time datetime="0201-01-01T00:01:44+08:27" itemprop="datePublished">Jan 1, 0201</time></p>
      <hr>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h4 id="문제-상황">문제 상황</h4>

<p>aws 계정을 새로 만든 상태로 eb 배포를 진행하기 위해 eb create 를 하던 중, 다음과 같은 에러 발생</p>

<pre><code class="language-Describe">Printing Status:
2019-05-13 11:16:51    INFO    createEnvironment is starting.
2019-05-13 11:16:53    INFO    Using elasticbeanstalk-ap-northeast-2-348718493386 as Amazon S3 storage bucket for environment data.
2019-05-13 11:17:14    INFO    Created target group named: arn:aws:elasticloadbalancing:ap-northeast-2:348718493386:targetgroup/awseb-AWSEB-TGBE799ODJOS/206a73cab621d890
2019-05-13 11:17:14    INFO    Created security group named: sg-0ca4aa5035c40afb0
2019-05-13 11:17:30    ERROR   Stack named 'awseb-e-386qseptfi-stack' aborted operation. Current state: 'CREATE_FAILED'  Reason: The following resource(s) failed to create: [AWSEBV2LoadBalancer, AWSEBSecurityGroup]. 
2019-05-13 11:17:30    ERROR   Creating load balancer failed Reason: API: elasticloadbalancingv2:CreateLoadBalancer User: arn:aws:iam::348718493386:user/EB_Full is not authorized to perform: iam:CreateServiceLinkedRole on resource: arn:aws:iam::348718493386:role/aws-service-role/elasticloadbalancing.amazonaws.com/AWSServiceRoleForElasticLoadBalancing
2019-05-13 11:17:30    ERROR   Creating security group named: awseb-e-386qseptfi-stack-AWSEBSecurityGroup-1L3VV4Q2YHUQ4 failed Reason: Resource creation cancelled
2019-05-13 11:17:32    INFO    Launched environment: testeb-dev. However, there were issues during launch. See event log for details.```
</code></pre>

<p>IAM 권한에 EBFullAccess 를 설정했는데도 불구하고 로그밸런서 생성에서 permission error 발생</p>

<h4 id="해결-방법원인">해결 방법/원인</h4>

<ul>
  <li>해결방법: IAM 정책에 로드밸런서를 생성과 관련된 권한을 추가해줘야함(인라인 추가)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "iam:CreateServiceLinkedRole",
            "Resource": "arn:aws:iam::*:role/aws-service-role/*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeAccountAttributes"
            ],
            "Resource": "*"
        }
    ]
}
</code></pre></div></div>

<ul>
  <li>원인: brandnew 에 해당하는 계정엔 loadbalancer 가 생성되어있지 않다. EBFullAccess 권한에 CreateServiceLinkedRole 권한이 포함되지 않은 상태로 로드밸런서 생성을 진행하게되고 이로인해 permission error 가 발생한다. EBFullAccess 의 경우, 이미 로드밸런서가 생성된 후에 진행한다고 가정하여 해당 권한이 포함되어있지 않았다.</li>
  <li>해결 방법 url: <a href="https://github.com/terraform-aws-modules/terraform-aws-eks/issues/103">https://github.com/terraform-aws-modules/terraform-aws-eks/issues/103</a></li>
</ul>

<h4 id="권한-정책-사용하는-법">권한 정책 사용하는 법</h4>

<p>에러를 다시 읽어보자</p>

<p><code class="highlighter-rouge">2019-05-13 11:17:30 ERROR Creating load balancer failed Reason: API: elasticloadbalancingv2:CreateLoadBalancer User: arn:aws:iam::348718493386:user/EB\_Full is not authorized to perform: iam:CreateServiceLinkedRole on resource: arn:aws:iam::348718493386:role/aws-service-role/elasticloadbalancing.amazonaws.com/AWSServiceRoleForElasticLoadBalancing</code></p>

<ul>
  <li>메시지 중 해결 방법을 알려주는 두가지 구문
    <ul>
      <li><code class="highlighter-rouge">to perform: iam:CreateServiceLinkedRole</code>
        <ul>
          <li>perform 은 Action 에 들어갈 내용을 의미</li>
        </ul>
      </li>
      <li><code class="highlighter-rouge">on resource: arn:aws:iam::348718493386:role/aws-service-role/elasticloadbalancing.amazonaws.com/AWSServiceRoleForElasticLoadBalancing</code>
        <ul>
          <li>resorce 는 Resource 에 들어갈 내용을 의미</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="고칠점느낀점">고칠점/느낀점</h4>

<p>에러구문을 보고 직접 권한 코드를 작성하는 시도를 하지 않았다. IAM 권한의 Statement, Effect, Action, Resource 에 대해 대충 읽을줄만 알고 작성해본 적이 없었기에 에러 메시지에 모든 해결 방법이 나와있음에도 몇시간을 낭비했다. 뭐가 됫든 에러 메시지를 토대로 직접 해결해보려고 노력했어야 했는데 구글 검색에 너무 의존하였다.</p>

  </div>

  <!-- To enable Disqus comments, comment out this code and insert your Disqus shortname -->

  <!--  -->

</article>

    </div>
</div>

      
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-2.x-git.min.js"></script>
      
    <!-- Bootstrap Core JavaScript -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <script src="/js/index.js"></script>

  </body>

    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>

    <script>
    $(document).ready(function(){
    $('#page-content-wrapper').fadeIn();
    });
    </script>

</html>
